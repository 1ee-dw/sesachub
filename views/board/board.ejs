<!DOCTYPE html>
<html lang="ko">
<%- include('../include/include.ejs', {title:"커뮤니티"}); %>
    <link rel="stylesheet" href="/static/css/board.css">
    <script src="/static/js/board/board.js"></script>

    <body>
        <%- include('../include/header.ejs'); %>
            <% let isBookmarked=board.bookmarks.some(bookmark=> bookmark.u_id === session.u_id); %>
                <div class="container">
                    <div class="center">
                        <main role="main">
                            <div class="content board"> <!-- 게시판에만 클래스 board추가 -->
                                <div id="board">
                                    <div class="table_box no_border">
                                        <table>
                                            <caption></caption>
                                            <colgroup>
                                                <col style="width:170px;">
                                                <col>
                                                <col style="width:170px;">
                                                <col>
                                            </colgroup>
                                            <tbody>
                                                <tr>
                                                    <th scope="row">제목</th>
                                                    <td colspan="3">
                                                        <h2>
                                                            <%=board.title%>
                                                        </h2>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <th scope="row">작성자</th>
                                                    <td rowspan="1">
                                                        <%=board.u_id%>
                                                    </td>
                                                    <th scope="row">작성일</th>
                                                    <td rowspan="1">
                                                        <%=board.createdAt.toLocaleString('ko-KR', { year: 'numeric' ,
                                                            month: '2-digit' , day: '2-digit' , hourCycle:'h24',
                                                            hour:'2-digit',minute:'2-digit',second:'2-digit' })%>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <th scope="row">내용</th>
                                                    <td colspan="3" class="board_content">
                                                        <%=board.content%>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="bottom_area">
                                        <span id="like_count">
                                            <%= board.dataValues.like_count%>
                                        </span>
                                        <button type="button"
                                            onclick="like('<%=board.b_id%>','<%=session.u_id%>')">좋아요</button>
                                        <div id="check_bookmark">
                                            <span>북마크</span>
                                            <% if (isBookmarked) {%>
                                                <a href="#" id="bookmark"
                                                    onclick="bookmark('<%=board.b_id%>','<%=session.u_id%>')">&#9733;</a>
                                                <%} else {%>
                                                    <a href="#" id="bookmark"
                                                        onclick="bookmark('<%=board.b_id%>','<%=session.u_id%>')">&#9734;</a>
                                                    <%}%>
                                        </div>
                                        <button onclick="page_update('<%=board.b_id%>')">수정</button>
                                        <button onclick="delete_board('<%=board.b_id%>')">삭제</button>
                                    </div>
                                </div>
                            </div>
                            <div class="comment_box">
                                <form name="comment">
                                    <input type="hidden" name="b_id" value="<%=board.b_id%>" />
                                    <input type="hidden" name="u_id" value="<%=session.u_id%>" />
                                    <input type="hidden" name="nk_name" value="<%=session.nk_name%>" />
                                    <select name="status">
                                        <option value="public">공개</option>
                                        <option value="private">비공개</option>
                                    </select>
                                    <textarea name="comment_content" rows="3" placeholder="댓글을 입력하세요"></textarea>
                                    <input type="button" class="btn" onclick="comment_insert()" value="댓글 작성">
                                </form>
                                <ul>
                                    <% for(comment of board.comments) {%>
                                        <li>
                                            <div class="cmt_top">
                                                <div class="cmt_nm">
                                                    <%=comment.nk_name%>
                                                </div>
                                                <div class="cmt_time">
                                                    <%=comment.createdAt.toLocaleString("ko-KR")%>
                                                </div>
                                                <select id="cmt<%=comment.c_id%>_status" style="display: none">
                                                    <option value="public">공개</option>
                                                    <option value="private">비공개</option>
                                                </select>
                                            </div>
                                        </li>
                                        <li id="cmt<%=comment.c_id%>_wrap">
                                            <span id="cmt<%=comment.c_id%>_content">
                                                <%=comment.content%>
                                            </span>
                                        </li>
                                        <li>
                                            <div class="cmt_bottom">
                                                <% if (session.u_id===comment.u_id) {%>
                                                    <input type="button" id="cmt_update_btn<%=comment.c_id%>"
                                                        onclick="change_comment('<%=comment.c_id%>')" value="댓글 수정" />
                                                    <input type="button" id="cmt_delete_btn<%=comment.c_id%>"
                                                        onclick="comment_delete('<%=comment.c_id%>')" value="댓글 삭제" />
                                                    <%}%>
                                                        <input type="button" class="btn" id="reply_btn<%=comment.c_id%>"
                                                            onclick="call_reply_form('<%=comment.c_id%>')"
                                                            value="답글 쓰기" />
                                            </div>
                                            <ul>
                                                <li>
                                                    <div class="cmt_reply">
                                                        <form name="reply_form<%=comment.c_id%>" style="display: none">
                                                            <input type="hidden" name="b_id" value="<%=board.b_id%>" />
                                                            <input type="hidden" name="u_id"
                                                                value="<%=session.u_id%>" />
                                                            <input type="hidden" name="parent_id"
                                                                value="<%=comment.c_id%>" />
                                                            <input type="hidden" name="nk_name"
                                                                value="<%=session.nk_name%>" />
                                                            <select name="status">
                                                                <option value="public">공개</option>
                                                                <option value="private">비공개</option>
                                                            </select>
                                                            <textarea name="reply_content" rows="3"
                                                                placeholder="댓글을 입력하세요" required></textarea>
                                                            <input type="button" id="reply_insert_btn" class="btn"
                                                                onclick="reply_insert('<%=comment.c_id%>')"
                                                                value="답글 작성" />
                                                        </form>
                                                        <% if (comment.replies.length> 0) {%>
                                                            <% for (reply of comment.replies) {%>
                                                <li>
                                                    <div class="reply_top">
                                                        <input type="hidden" value="<%=reply.parent_id%>">
                                                        <%=reply.nk_name %>
                                                            <%=reply.createdAt.toLocaleString("ko-KR")%>
                                                                <select id="cmt<%=reply.c_id%>_status"
                                                                    style="display:none">
                                                                    <option value="public">공개</option>
                                                                    <option value="private">비공개</option>
                                                                </select>
                                                    </div>
                                                <li id="cmt<%=reply.c_id%>_wrap">
                                                    <span id="cmt<%=reply.c_id%>_content">
                                                        <%=reply.content%>
                                                    </span>
                                                </li>
                                                <div class="reply_btm">
                                                    <% if (session.u_id===reply.u_id) {%>
                                                        <input type="button" id="cmt_update_btn<%=reply.c_id%>"
                                                            onclick="change_comment('<%=reply.c_id%>')" value="댓글 수정" />
                                                        <input type="button" id="cmt_delete_btn<%=reply.c_id%>"
                                                            onclick="comment_delete('<%=reply.c_id%>')" value="댓글 삭제" />
                                                        <%}%>
                                                            <input type="button" class="btn"
                                                                id="reply_btn<%=reply.c_id%>"
                                                                onclick="call_reply_form('<%=reply.c_id%>')"
                                                                value="답글 쓰기" />
                                                </div>
                                        </li>
                                        <%}%>
                                            <%}%>
                            </div>
                            </li>
                            </ul>
                            </li>
                            <%}%>
                                </ul>
                    </div>
                    </main>
                </div>
                </div>
                <script>
                    const isBookmarked = board.bookmarks.some(bookmark => bookmark.u_id === session.u_id);
                    const format_date = function (date) {
                        let year = date.getFullYear();
                        let month = new String(date.getMonth() + 1).padStart(2, "0");
                        let day = new String(date.getDate()).padStart(2, "0");

                        return year + "-" + month + "-" + day;
                    }
                </script>
    </body>

</html>